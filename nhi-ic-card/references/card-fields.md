# 健保IC卡欄位結構參考

本文件提供台灣健保 IC 卡的資料儲存結構知識，包含四大區段定義、欄位格式、RegisterPrevent 解析。

## BhpNhi.dll 可讀取 vs 完整卡片的差異

### BhpNhi.dll 可直接取得的欄位（GetPersonData）

| 欄位 | 對應 Person 屬性 | 說明 | 長度 |
|------|-----------------|------|------|
| 醫療院所代號 | `HospId` | 從 SAM 卡讀取 | 10 |
| 安全模組卡號 | `SamId` | SAM 卡序號 | 12 |
| 民眾健保卡號 | `CardId` | 卡片序號 | 12 |
| 民眾身分證號 | `Pid` | 身分證字號 | 10 |
| 民眾出生日期 | `Birth` | 民國年 YYYMMDD | 7 |
| 預防保健註記 | `RegisterPrevent` | 多筆紀錄串接字串 | 變動 |

### 需要 CsHis.dll 才能存取的欄位

BhpNhi.dll 只提供 6 個基本欄位。要讀取完整卡片資料（如姓名、性別、重大傷病、就醫紀錄、過敏藥物等），需要直接使用 CsHis.dll 的原生 API：

| CsHis.dll 方法 | 讀取內容 |
|---------------|---------|
| `NHIhisGetBasicData` | 基本資料區全部欄位 |
| `NHIhisGetTreatData` | 就醫紀錄（最近 6 次） |
| `NHIhisGetRegisterPrevent` | 預防保健註記 |

---

## 區段一：基本資料（8 欄位）

| 欄位名稱 | 長度 | 屬性 | 說明 |
|----------|------|------|------|
| 卡片號碼 | 12 | 英數字 | 健保卡序號 |
| 姓名 | 20 | 中英數字 | 持卡人姓名 |
| 身分證號 | 10 | 英數字 | 身分證字號 |
| 出生日期 | 7 | 數字 | 民國年 YYYMMDD |
| 性別 | 1 | 數字 | 1=男, 2=女 |
| 發卡日期 | 7 | 數字 | 民國年 YYYMMDD |
| 卡片註銷註記 | 1 | 數字 | 0=正常, 1=註銷 |
| 照片 | - | 二進位 | 持卡人照片 |

---

## 區段二：健保資料段（67 欄位，全部隱藏）

### 投保資料

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 保險人代碼 | 2 | 投保單位 |
| 保險對象身分註記 | 1 | 身分類別 |
| 卡片有效期限 | 7 | 民國年 YYYMMDD |

### 重大傷病

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 重大傷病註記（一）~（六） | 各含代碼+起迄日 | 最多 6 筆重大傷病 |

每筆重大傷病包含：
- 重大傷病代碼（ICD 碼）
- 起始日期（7 位，民國年）
- 截止日期（7 位，民國年）

### 特殊醫療服務

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 牙醫一般服務註記 | 1 | |
| 罕見疾病註記 | 1 | |
| 油症患者就醫註記 | 1 | |

### 就醫紀錄（最近 6 次）

IC 卡儲存最近 **6 次**就醫紀錄，每筆包含：

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 就醫類別 | 2 | 01=西醫門診, 02=牙醫門診, 03=中醫門診, 04=急診, 05=住院... |
| 就醫日期時間 | 13 | YYYMMDDHHMMSS |
| 醫療院所代碼 | 10 | |
| 醫師身分證號 | 10 | |
| 主診斷碼 | 7 | ICD-10 |
| 次診斷碼（一）~（五） | 各 7 | ICD-10 |
| 給藥日份 | 3 | 天數 |
| 就醫序號 | 4 | |
| 補卡註記 | 1 | |
| 部分負擔 | 3 | |

### 預防保健紀錄

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 最近一次就醫序號 | 4 | |
| 新生兒依附就醫註記 | 1 | |
| 成人預防保健紀錄 | 變動 | 多筆紀錄串接（見下方 RegisterPrevent 解析） |

---

## 區段三：醫療專區（26 欄位）

### 處方紀錄

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 長期處方箋（一）~（六） | 各含藥品碼+頻率+天數 | 最多 6 筆 |

### 過敏藥物

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 過敏藥物（一）~（三） | 各 12 | 藥品代碼，最多 3 筆 |

---

## 區段四：衛生行政專區（17 欄位）

### 疫苗接種紀錄

| 欄位名稱 | 長度 | 說明 |
|----------|------|------|
| 疫苗接種紀錄（一）~（六） | 各含疫苗碼+日期+批號 | 最多 6 筆 |

每筆疫苗紀錄包含：
- 疫苗種類代碼
- 接種日期（民國年 YYYMMDD）
- 疫苗批號

---

## RegisterPrevent 欄位解析

BhpNhi.dll 的 `GetPersonData()` 回傳的 `RegisterPrevent` 是一個長字串，由多筆預防保健紀錄串接而成。

### 紀錄結構

每筆紀錄為固定長度的子字串，依序串接。從範例程式截圖中的實際值：

```
00102010135012000002101102010235012000012202102010335012000022301020104350120
```

這串資料包含多筆服務紀錄，每筆紀錄編碼了：
- 服務類別代碼
- 服務日期（民國年）
- 服務院所代碼
- 服務狀態/結果

### 解讀方式

由於此欄位格式為健保署內部編碼，完整解析規則需參考：
- `健保卡存放內容_1141030公告修訂.pdf` 中的預防保健紀錄區段定義
- `3285_健保IC卡存放內容.xls` 中對應欄位的詳細說明

> **實務建議**: 一般開發者不需自行解析 RegisterPrevent。BhpNhi.dll 的 ValidAll() 等方法會自動讀取並比對此欄位，直接回傳資格查詢結果。只有在需要**離線判斷**或**自建判斷邏輯**時才需要解析。

---

## 日期格式

所有 IC 卡日期欄位使用**民國年** YYYMMDD 格式（7 位數字字串）：

```
YYY = 西元年 - 1911（3 位，不足補零）
MM  = 月份（2 位）
DD  = 日期（2 位）

範例：
1150216 = 民國 115 年 2 月 16 日 = 2026-02-16
1120801 = 民國 112 年 8 月 1 日  = 2023-08-01
0930101 = 民國 93 年 1 月 1 日   = 2004-01-01
```

### C# 轉換

```csharp
// 民國年字串 → DateTime
string rocDate = "1150216";
int year = int.Parse(rocDate.Substring(0, 3)) + 1911;
int month = int.Parse(rocDate.Substring(3, 2));
int day = int.Parse(rocDate.Substring(5, 2));
DateTime date = new DateTime(year, month, day);

// DateTime → 民國年字串
string ToRocDate(DateTime dt) =>
    $"{dt.Year - 1911:D3}{dt.Month:D2}{dt.Day:D2}";
```

---

## 資料屬性說明

IC 卡欄位有三種資料屬性：

| 屬性 | 說明 | 範例 |
|------|------|------|
| 數字 | 純數字 0-9 | 出生日期、性別 |
| 英數字 | 英文字母 + 數字 | 身分證號、卡片號碼 |
| 中英數字 | 中文 + 英文 + 數字 | 姓名 |

---

## 上傳旗標

每個欄位都有上傳旗標，標記在哪些場景下需要上傳到健保署：

| 旗標 | 說明 |
|------|------|
| 門診 | 門診就醫時上傳 |
| 住院 | 住院時上傳 |
| 出院 | 出院時上傳 |

---

## Gotchas

1. **BhpNhi.dll 只讀 6 個欄位** — 不要期待從 GetPersonData() 拿到姓名、性別、重大傷病等。完整讀卡需用 CsHis.dll。

2. **就醫紀錄只保留 6 次** — IC 卡上的就醫紀錄是循環覆蓋的，只有最近 6 次。需要完整歷史要查 HIS 資料庫。

3. **過敏藥物最多 3 筆** — IC 卡上只能存 3 筆過敏藥物，不代表病人只對 3 種藥物過敏。

4. **疫苗紀錄最多 6 筆** — 同理，IC 卡疫苗紀錄有上限。

5. **重大傷病最多 6 筆** — 有效期限需注意，過期的重大傷病仍佔位。

6. **RegisterPrevent 不需自行解析** — 除非離線判斷，否則直接用 ValidAll() 等 API 即可。

7. **隱藏欄位** — 健保資料段的 67 個欄位在 Excel 規格中標記為「隱藏」，表示一般應用不直接顯示。
