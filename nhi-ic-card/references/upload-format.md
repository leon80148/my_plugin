# 健保卡資料上傳格式 2.0

本文件提供健保卡資料上傳 XML 格式 2.0 的完整規範知識。包含 XML 結構、欄位規則、異常上傳、補卡、急診住院等情境。

## XML 格式概覽

### 編碼與宣告

```xml
<?xml version="1.0" encoding="Big5"?>
<RECS>
  <REC>
    <MSH>表頭段</MSH>
    <MB>
      <MB1>健保資料段</MB1>
      <MB2>醫令1</MB2>
      <MB2>醫令2</MB2>
    </MB>
  </REC>
</RECS>
```

### XML 結構規則

| 標籤 | 說明 | 必要性 |
|------|------|--------|
| `<RECS>` | 整批上傳資料外層包裹，**只能有一個** | 必要 |
| `<REC>` | 單筆就醫紀錄，可有多筆 | 必要 |
| `<MSH>` | 表頭段（M01~M05 基本識別資料） | 必要 |
| `<MB>` | 資料訊息本體 | 必要 |
| `<MB1>` | 健保資料段（就醫類別、日期、序號等） | 必要 |
| `<MB2>` | 醫療專區醫令（可多筆，無醫令時省略） | 選擇性 |

### XML 退件原則

1. 缺少 `<MSH></MSH>` 表頭
2. 有 `<MB2>` 但缺少 `<MB1>`
3. 缺少 `</RECS>` 結尾
4. M05（醫療院所代碼）與上傳機構不符
5. 已使用 1.0 格式後改用 2.0 格式
6. XML 格式不合法或有多個 `<RECS>`
7. 上傳限當月及前 3 個月

---

## 資料型態 (H00)

| H00 值 | 說明 | 對應附件 |
|---------|------|----------|
| `1` | 健保就醫資料 | 附件 1 |
| `2` | 預防接種資料 | 附件 2 |
| `3` | 藥物過敏及不良反應資料 | 附件 3 |
| `4` | 其他資料 | 附件 4 |

## 資料格式 (H01)

| H01 值 | 說明 | 使用時機 |
|---------|------|----------|
| `A` | 正常上傳 | 一般就醫、正常讀卡 |
| `B` | 異常上傳 | 無法正常讀卡，需搭配異常就醫序號 |
| `C` | 註銷未調劑慢連箋 | 取消慢連箋 |
| `D` | 整筆刪除 | 刪除已上傳的就醫資料 |
| `E` | 取消 C | 取消註銷操作 |

---

## MSH 表頭段欄位

| XML ID | 欄位名稱 | 格式 | 說明 |
|--------|----------|------|------|
| M01 | 安全模組代號 | X(12) | SAM 卡序號 |
| M02 | 卡片號碼 | X(12) | 須與卡片檔案一致 |
| M03 | 身分證號 | X(10) | 須與卡片檔案一致 |
| M04 | 出生日期 | 9(07) | 民國年 YYYMMDD，須與卡片一致 |
| M05 | 醫療院所代碼 | X(10) | 須存在於合約機構清單，須與 SAM 卡一致 |

---

## MB1 健保資料段主要欄位

| XML ID | 欄位名稱 | 格式 | 說明 |
|--------|----------|------|------|
| H00 | 資料型態 | X(01) | 1/2/3/4（見上表） |
| H01 | 資料格式 | X(01) | A/B/C/D/E（見上表） |
| M06 | 醫事人員身分證號 | X(10) | 看診醫師 |
| M07 | 就醫類別 | X(02) | 見就醫類別代碼表 |
| M08 | 新生兒出生日期 | 9(07) | 依附就醫用 |
| M09 | 新生兒胞胎註記 | 9(01) | 1=單胎, 2=雙胞胎... |
| M10 | 新生兒就醫註記 | X(01) | 胎次+性別（A/a=第1胎男/女） |
| M11 | 就診日期時間 | 9(13) | YYYMMDDHHMMSS（M12≠1 時為補卡刷卡時間） |
| M12 | 補卡註記 | X(01) | 1=正常, 2=補卡, 3=新生兒無ID補卡, 4=無M52補卡 |
| M13 | 就醫序號 | X(04) | 見就醫序號規則 |
| M14 | 安全簽章 | X(256) | 卡片安全簽章 |
| M15 | 就醫識別碼 | X(20) | 所有健保身分就醫均須取得 |
| M16 | 原就醫識別碼 | X(20) | 後續治療/調劑填入原次 |
| M17 | 原處方服務機構代號 | X(10) | 交付調劑時填原處方機構 |
| M18 | 原處方就醫序號 | X(04) | 交付調劑時填原序號 |
| M19 | 原就診日期時間 | 9(13) | 無時間部分補 000000 |
| M20 | 給藥日份 | 9(03) | 口服藥(PO/SC)最大值 |
| M21 | 慢連箋總給藥天數 | 9(02) | 處方種類-C |
| M22 | 管制藥品慢連箋總給藥天數 | 9(02) | 處方種類-F |
| M23 | 處方調劑方式 | X(01) | 0=自行調劑, 1/C/D=交付調劑 |
| M45 | 部分負擔費用 | 9(05) | 必填 |
| M49 | 實際就醫日期時間 | 9(13) | 補卡時填原就醫時間 |
| M50 | 病床號 | X(05) | 住院/透析必填，特殊碼見下方 |
| M51 | 給付類別 | X(01) | 4=一般, 1/2=職災 |
| M52 | 實際就醫識別碼 | X(20) | 補卡時填原就醫時取得的 |
| M54 | 部分負擔費用(2) | 9(05) | 必填 |

---

## 就醫類別 (M07) 代碼表

### 門診類別 (01~09, AC~AI)

| M07 | 說明 | 就醫序號 |
|-----|------|----------|
| `01` | 西醫門診 | 需取號 |
| `02` | 牙醫門診 | 需取號 |
| `03` | 中醫門診 | 需取號 |
| `04` | 急診 | 需取號 |
| `05` | 住院 | 需取號 |
| `06` | 復健-物理治療 | 需取號 |
| `07` | 復健-職能治療 | 需取號 |
| `08` | 復健-語言治療 | 需取號 |
| `09` | 居家照護 | 需取號 |
| `AC` | 預防保健 | ICxx 格式 |
| `AD` | 職業傷害或職業病門(急)診 | 不取號（空值） |
| `AE` | 慢性病連續處方箋領藥 | 不取號 |
| `AF` | 藥局調劑 | 不取號 |
| `AI` | 同日同醫師看診 | 不取號，僅 MB1 段 |

### 住院/急診類別 (BA~EA)

| M07 | 說明 |
|-----|------|
| `BA` | 急診轉住院 |
| `BB` | 出院（含重要醫令） |
| `BC` | 急診/住院期間醫令 |
| `BD` | 急診離院（每次急診必傳） |
| `BE` | 新生兒依附住院 |
| `BF` | 住院繼續住院結算 |
| `BG` | 門診轉住院 |
| `AK` | 急診觀察（>6小時，每日傳） |
| `CA` | 論日計酬-住院 |
| `DA` | 論日計酬-門診 |
| `DB` | 論日計酬-復健 |
| `EA` | 轉床/轉科 |

---

## 就醫序號 (M13) 規則

### 正常上傳 (H01=A)

| M07 | M13 填法 |
|-----|----------|
| `01`~`09` | 由控制軟體取得之就醫序號 |
| `AC` | ICxx 格式（依國健署規範） |
| 其他 | **空值** |

### 異常上傳 (H01=B) — 異常就醫序號

| 異常原因 | 異常序號 | 說明 |
|----------|----------|------|
| 讀卡異常 | `A000`/`A001` | 不通電 / 讀卡 API 失敗 |
| 讀卡異常 | `A010`/`A011` | 卡片損壞 |
| 讀卡異常 | `A020`/`A021` | 未帶卡 |
| 讀卡異常 | `A030`/`A031` | 讀卡機故障 |
| 停電 | `C000` | 停電 |
| HIS 當機/電腦死當 | `D000`/`D001` | 無法開機 |
| 電腦故障 | `D010`/`D011` | 硬體故障 |
| 新生兒未具健保身分 | `ICND` | 未具健保身分生產案件 |
| 急診/住院無法插卡 | `J000` | 急診、住院結算等 |
| 新約特約60日內 | `G000` | 新特約機構 |
| 卡片遺失 | `E000` | 已掛失 |
| VPN 斷線 | `B000`/`B001` | 無法連線 |

> **重要**: 使用異常就醫序號時，須填寫「健保卡作業異常狀況報備單」(表1)，且須在申報前完成報備。

---

## 就醫識別碼 (M15/M16/M52)

### M15 — 就醫識別碼

- 所有健保身分就醫均須取得（包含自費就醫，事後補卡使用）
- 正常取得：透過控制軟體 API 讀卡取得
- 異常取得：使用 `API-1.54 hisGetTreatNumNoICCard` 取得

### M16 — 原就醫識別碼

用於後續治療、調劑等非首次就醫。除 M07=01~09、AC、AD、BE、CA、DA、DB 外均需填入。

**異常情境 M16 特殊值：**

| 對應 M18 | M16 值 | 情境 |
|----------|--------|------|
| C000 | C000+16個0 | 停電 |
| G000 | G000+16個0 | 新約特約60日內 |
| D000 | D000+16個0 | HIS 當機 |
| A000 | A000+16個0 | 讀卡異常 |
| E000 | E000+16個0 | 卡片遺失 |
| B000/B001 | B000+16個0 | VPN 斷線 |

### M52 — 實際就醫（調劑或檢查）之就醫識別碼

- 補卡 (M12=2/3/4) 時填入**原就醫當時**取得的就醫識別碼
- 無法取得時填 `MISS0000000000000000`（MISS+16個0），須填寫報備單(表2)

---

## 補卡原則 (M12)

### 補卡註記值

| M12 | 說明 | 使用時機 |
|-----|------|----------|
| `1` | 正常 | 一般就醫 |
| `2` | 補卡 | 10日內（不含假日）或出院前補刷 |
| `3` | 新生兒無身分證號補卡 | 出生>60天且≤92天 |
| `4` | 無實際就醫識別碼之補卡 | 無法取得 M52，須報備 |

### 補卡時欄位對應

| 欄位 | 正常 (M12=1) | 補卡 (M12=2) |
|------|-------------|-------------|
| M11 | 就診日期時間 | **補卡刷卡時間** |
| M15 | 本次就醫識別碼 | **補卡時取得之識別碼** |
| M49 | （不填） | **原就醫日期時間** |
| M52 | （不填） | **原就醫時取得之識別碼** |

---

## 急診/住院上傳注意事項

### 急診

1. **急診離院 (BD)**: 每次急診都必須上傳，無法插卡時用 J000
2. **急診觀察 >6小時 (AK)**: 需在每日 23:59 前上傳
   - 第 1 天: M11 = 急診入院 6 小時後
   - 之後每天: M11 = 00:00:00
3. **急診期間醫令 (BC)**: 用於急診期間重要醫令上傳

### 住院

1. **轉床/轉科 (EA)**: 於轉出當日 23:59 前上傳
2. **住院繼續結算 (BF)**: 須登錄健保卡，可用 J000 異常就醫序號
3. **出院 (BB)**: 含重要住院醫令上傳，或出院後 7 天內以 DC 補傳
4. **門診轉住院 (BG)**: 原就醫類別為 01/02/06/07/08/09/AD
5. **急診轉住院 (BA)**: 原就醫類別為 04/AD

### 病床號 (M50) 特殊代碼

| 代碼 | 說明 |
|------|------|
| `RRRRR` | 產房 |
| `HB` | 居家生產 |
| `DW` | 精神科日間病房 |
| `ER` | 急診觀察超過登記床數 |

---

## 上傳方式

| 上傳管道 | 格式 1.0 預檢 | 格式 1.0 正式 | 格式 2.0 預檢 | 格式 2.0 正式 |
|----------|:---:|:---:|:---:|:---:|
| VPN 網頁 | V | — | V | — |
| 控制軟體函式 | — | V | — | — |
| Web API | — | — | V | V |

### 檢核結果

- VPN 網頁: 14 天內可查詢下載
- Web API: 3 天內可下載
- 檢核正確且無提醒: VPN 不提供結果檔，Web API 僅提供 JSON

---

## 職災就醫身分變更

當病人先以一般健保就醫，事後持職災單辦理身分變更：

1. **24小時內**: 健保卡登錄「退掛」→ 以 M07=AD 重新過卡
2. **超過24小時**: 無法變更卡片內容，不須退掛
3. **上傳方式**:
   - 原就醫資料以 H01=D 整筆刪除
   - 以 M12=2 補卡 + M07=AD 上傳新資料
   - M49/M52 填原就醫資料的 M11/M15

---

## 24小時上傳規定

- 就醫資料應於 **24 小時內** 經 VPN 上傳
- 異常狀況須填寫「健保卡作業異常狀況報備單」(表1)
- 搭配「異常就醫序號」上傳
- **須在申報前完成報備**

---

## 給藥日份 (M20) 填寫規則

1. 不同給藥途徑時，填當次**口服藥** (PO 或 SC) 的最大值；若無口服藥則填該次處方最大值
2. 慢性病連續處方調劑，依處方箋上所列給藥日份填寫
3. 門診戒菸計畫 (M07=AC) 且藥局提供戒菸追蹤者，填 `0`

---

## C# XML 上傳範例

```csharp
// 產生單筆正常門診上傳 XML
string GenerateUploadXml(
    string samId, string cardId, string pid, string birth,
    string hospId, string doctorId, string visitDateTime,
    string treatNum, string treatId, string signature)
{
    return $@"<?xml version=""1.0"" encoding=""Big5""?>
<RECS>
  <REC>
    <MSH>
      <M01>{samId}</M01>
      <M02>{cardId}</M02>
      <M03>{pid}</M03>
      <M04>{birth}</M04>
      <M05>{hospId}</M05>
    </MSH>
    <MB>
      <MB1>
        <H00>1</H00>
        <H01>A</H01>
        <M06>{doctorId}</M06>
        <M07>01</M07>
        <M11>{visitDateTime}</M11>
        <M12>1</M12>
        <M13>{treatNum}</M13>
        <M14>{signature}</M14>
        <M15>{treatId}</M15>
      </MB1>
    </MB>
  </REC>
</RECS>";
}
```

---

## Gotchas

1. **編碼是 Big5 不是 UTF-8** — XML 宣告必須用 `encoding="Big5"`，否則退件。

2. **MB2 是選擇性的** — 無開立醫令時不傳 `<MB2>`，但有醫令時每筆醫令各自一組 `<MB2></MB2>`。

3. **M07 非 01~09 和 AC 時，M13 必須為空值** — 很多就醫類別（AD、AE、AF 等）不需取就醫序號。

4. **M11 在補卡時意義不同** — M12=1 時 M11 是就診時間，M12≠1 時 M11 是**補卡刷卡時間**，原就醫時間要填 M49。

5. **急診離院 (BD) 必傳** — 每次急診都必須上傳 BD，不管是否有 AK 或 BC。

6. **整筆刪除後要重傳** — H01=D 只是刪除，身分變更等需要接著以新就醫類別重新上傳。

7. **上傳限當月及前3個月** — 超過此範圍的資料無法上傳。

8. **AI 只傳 MB1** — 同日同醫師看診的修改醫令，要在原就醫類別(01-09/AD)資料中增修重傳。

9. **異常就醫序號須配合報備** — 使用 B/D 異常上傳必須有報備單，否則申報可能被退。

10. **M19 無時間補零** — 原就診日期時間如無時間部分，後 6 碼補 0，如 `1110901000000`。
