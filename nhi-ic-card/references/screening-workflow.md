# 成健暨BC肝篩檢工作流程

本文件提供成人預防保健與 B、C 型肝炎篩檢的完整業務流程知識。同時服務診所人員（理解查詢結果）和開發者（整合到 HIS 系統）。

## 篩檢資格規則

### 成人預防保健（成健）

| 對象 | 年齡 | 頻率 |
|------|------|------|
| 一般身分 | 40-64 歲 | 每 3 年 1 次 |
| 一般身分 | 65 歲以上 | 每年 1 次 |
| 原住民 | 55 歲以上 | 每年 1 次 |

### B、C 型肝炎篩檢（BC肝）

| 對象 | 年齡 | 頻率 |
|------|------|------|
| 一般身分 | 45-79 歲 | **終身 1 次** |
| 原住民 | 40-79 歲 | **終身 1 次** |

---

## 資格查詢結果白話對照表

### 給櫃台/護理人員看的

| 結果碼 | 白話意思 | 建議動作 |
|--------|---------|---------|
| `0101-00` | BC肝和成健**都可以做**（一般身分） | 跟病人說明兩項都符合，安排時段 |
| `0101-01` | BC肝和成健**都可以做**（原住民） | 同上 |
| `0001-00` | 只有**成健可以做** | 安排成人健檢 |
| `0100-00` | 只有**BC肝可以做** | 詢問病人意願，安排抽血 |
| `0001-01` | 只有**成健可以做**（原住民） | 安排成人健檢 |
| `0100-01` | 只有**BC肝可以做**（原住民） | 詢問病人意願 |
| `0303-00` | 兩個**都做過了** | 告知已完成，無需再做 |
| `0303-01` | 兩個**都做過了**（原住民） | 同上 |
| `0203-00` | BC肝**年齡不符**，成健**已做過** | 無需動作 |
| `0302-00` | BC肝**已做過**，成健**年齡不符** | 無需動作 |
| `0202-00` | 兩個**年齡都不符** | 無需動作 |
| `0201-00` | BC肝**年齡不符**，成健**可以做** | 只安排成健 |
| `0103-00` | BC肝**可以做**，成健**已做過** | 只安排BC肝 |

### 結果碼解碼速記

```
前兩碼 = BC肝    後兩碼(橫線前) = 成健    橫線後 = 身分
  01 = 可以做      01 = 可以做              00 = 一般
  02 = 年齡不到    02 = 年齡不到            01 = 原住民
  03 = 已做過      03 = 已做過
  00 = 沒有查      00 = 沒有查
```

---

## 登記與取消結果白話對照

### BC肝篩檢登記

| 結果碼 | 白話意思 | 動作 |
|--------|---------|------|
| `1100-00` | **登記成功**（一般身分） | 確認完成，可繼續看診流程 |
| `1100-01` | **登記成功**（原住民） | 同上 |
| `1200-0X` | **登記失敗**，年齡不符 | 確認病人年齡，可能不在篩檢範圍 |
| `1300-0X` | **登記失敗**，已做過 | 病人之前已做過BC肝篩檢（終身1次） |

### BC肝篩檢取消

| 結果碼 | 白話意思 | 動作 |
|--------|---------|------|
| `2100-00` | **取消成功** | 確認已取消登記 |
| `2100-01` | **取消成功**（原住民） | 同上 |
| `2200-0X` | **取消失敗**，沒有登記紀錄 | 確認是否在本院所登記的 |
| `2300-0X` | **取消失敗**，已經過了取消期限 | 聯繫健保署處理 |

---

## 業務流程

### 標準流程：掛號 → 查詢 → 看診 → 登記

```
[患者到診所掛號]
       │
       ▼
[插入健保卡，讀卡] ← GetPersonData()
       │
       ▼
[查詢篩檢資格] ← ValidAll()
       │
       ├─ 結果含 "01" → 符合資格
       │   │
       │   ▼
       │  [提示櫃台/醫師：此患者符合 ○○ 篩檢]
       │   │
       │   ▼
       │  [醫師看診，確認執行篩檢]
       │   │
       │   ▼
       │  [完診後登記 BC 肝] ← RegisterBcLiver()
       │   │
       │   ├─ 1100 → 登記成功
       │   ├─ 1200 → 年齡不符（不應發生，前面已查過）
       │   └─ 1300 → 已做過（不應發生）
       │
       ├─ 結果含 "02" → 年齡不符
       │   └─ 無需動作
       │
       └─ 結果含 "03" → 已做過
           │
           ▼
          [告知患者已完成]
           │（如需查前次機構）
           ▼
          [同日再次查詢] → 知情同意確認 → 顯示前次機構
```

### 誤登記取消流程

```
[發現誤登記 BC 肝]
       │
       ▼
[插卡讀卡] ← GetPersonData()
       │
       ▼
[取消登記] ← CancelBcLiver()
       │
       ├─ 2100 → 取消成功
       ├─ 2200 → 本院所沒有登記紀錄（確認是否在其他院所登記）
       └─ 2300 → 超過取消期限（需聯繫健保署）
```

### 第二次查詢（查前次服務機構）

當患者**已做過**篩檢（結果碼含 `03`），如需查詢前次在哪個機構做的：

1. **同一天、同一院所、同一患者**再次點選資格查詢
2. 系統彈出「**知情同意**」確認視窗
3. 確認已取得民眾知情同意後
4. 回傳結果 Description 中將包含前次服務機構名稱和日期

> 例如：「(一般身分)於20210913(衛生福利部○○醫院)已做過BC肝篩檢，不符合資格。於20240313(○○醫院○○分院)做過成人健檢，不符合資格。」

---

## 與展望 HIS（vision-database）整合

### 資料表對應

| 篩檢功能 | 展望資料表 | 關鍵欄位 | 說明 |
|----------|----------|---------|------|
| 患者身分比對 | **CO01M** | `MPERSONID` ↔ IC卡 `Pid` | 身分證號比對 |
| 掛號觸發查詢 | **CO05O** | `TBKDT`(掛號日), `TSTS`(狀態) | 掛號時自動觸發 ValidAll() |
| 成健就診紀錄 | **CO03L** | `LISRS` 案件類別 | 判斷院內是否已有紀錄 |
| 完診後登記 | **CO03L** | `LTIME` 完診時間 | 完診後觸發 RegisterBcLiver() |

### CO03L.LISRS 預防保健案件類別代碼

| LISRS 代碼 | 對應篩檢 |
|-----------|---------|
| `3D`, `21`, `22` | 成人健檢第一階段 |
| `3E`, `23`, `24` | 成人健檢第二階段 |
| `85` | 大腸癌篩檢 |
| `95` | 口腔癌篩檢 |
| `AU` | 流感疫苗 |

### 整合查詢範例

```sql
-- 找出近期掛號但尚未做過成健的患者（潛在篩檢對象）
SELECT o.KCSTMR, m.MNAME, m.MBIRTHDT, m.MPERSONID
FROM CO05O o
JOIN CO01M m ON o.KCSTMR = m.KCSTMR
WHERE o.TBKDT >= '1150101'  -- 民國115年起
  AND o.TSTS IN ('0','1')   -- 候診或看診中
  AND NOT EXISTS (
    SELECT 1 FROM CO03L l
    WHERE l.KCSTMR = o.KCSTMR
      AND l.LISRS IN ('3D','21','22','3E','23','24')
      AND l.DATE >= '1140101'  -- 近一年內
  )
ORDER BY o.TBKDT DESC;
```

```sql
-- 統計本月 BC 肝篩檢登記量
SELECT COUNT(DISTINCT KCSTMR) as 篩檢人次
FROM CO03L
WHERE DATE LIKE '11502%'       -- 民國115年2月
  AND LISRS IN ('3D','21','22','3E','23','24');
```

---

## 常見問題 FAQ

**Q: 病人說沒做過，但系統顯示「已做過」？**
A: 可能是在其他醫療機構做過。可用同日第二次查詢功能確認前次機構（需取得病人知情同意）。

**Q: 原住民身分是怎麼判定的？**
A: 由 API 後端根據戶政資料自動判定，回應碼末兩碼 `01` = 原住民，`00` = 一般身分。院所無需手動設定。

**Q: BC肝篩檢是終身只能做一次嗎？**
A: 是的，BC肝篩檢為終身一次的服務。一旦做過，之後查詢都會顯示「已做過」。

**Q: 登記後發現搞錯人了怎麼辦？**
A: 盡快使用 CancelBcLiver() 取消。注意有時間限制，超過期限（2300 錯誤碼）需聯繫健保署。

**Q: 為什麼連不上 API？**
A: 檢查：1) 網路連線 2) 主控台是否啟動 3) 讀卡機是否正常。技術細節見 api-development.md 的疑難排解。

**Q: 成健多久可以做一次？**
A: 一般身分 40-64 歲每 3 年 1 次，65 歲以上每年 1 次。原住民 55 歲以上每年 1 次。

---

## Gotchas

1. **第二次查詢不是 bug** — 同日同院所同個案再次查詢時彈出知情同意視窗是正常設計，不要驚慌。

2. **BC肝終身一次** — 不同於成健可以定期做，BC肝篩檢是終身只有一次機會。

3. **登記 ≠ 執行** — RegisterBcLiver() 是在系統上登記，不代表實際已完成篩檢。務必在確認執行後才登記。

4. **取消有時效** — CancelBcLiver() 超過一定期限會失敗（2300-0X），需要盡快處理。

5. **查詢不影響資格** — 單純查詢（ValidAll/ValidAdult/ValidBcLiver）不會改變患者的資格狀態，只有 Register/Cancel 會。
